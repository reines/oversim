<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: SimpleTCPConnection Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-attribs">Static Public Attributes</a> &#124;
<a href="#pro-methods">Protected Member Functions</a>  </div>
  <div class="headertitle">
<h1>SimpleTCPConnection Class Reference</h1>  </div>
</div>
<div class="contents">
<!-- doxytag: class="SimpleTCPConnection" -->
<p><code>#include &lt;<a class="el" href="SimpleTCP_8h_source.html">SimpleTCP.h</a>&gt;</code></p>

<p><a href="classSimpleTCPConnection-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#afb617c21fcd5a0d0f2473b18c9402c6e">SimpleTCPConnection</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#a63d9cfb0c22610e1986ec0474e48aa48">SimpleTCPConnection</a> (TCP *mod, int appGateIndex, int connId)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#aef7a2dec538af071e0c7706cd9ec9686">sendToIP</a> (TCPSegment *tcpseg)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Utility: adds control info to segment and sends it to the destination node.  <a href="#aef7a2dec538af071e0c7706cd9ec9686"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#a2a90f7b7c30ac18b6bb8976d36f56623">sendRst</a> (uint32 seq, IPvXAddress src, IPvXAddress dest, int srcPort, int destPort)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Utility: sends RST; does not use connection state.  <a href="#a2a90f7b7c30ac18b6bb8976d36f56623"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#a34e0bd4cc145e5b2247a709fa41366c2">sendRstAck</a> (uint32 seq, uint32 ack, IPvXAddress src, IPvXAddress dest, int srcPort, int destPort)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Utility: sends RST+ACK; does not use connection state.  <a href="#a34e0bd4cc145e5b2247a709fa41366c2"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="pub-static-attribs"></a>
Static Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structStatisticsAndDelay.html">StatisticsAndDelay</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#a03830f7573a62f195399f9d079be26a4">sad</a></td></tr>
<tr><td colspan="2"><h2><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#a5ab8e1fecb4a30b73b211cbae1c66f99">sendToIP</a> (TCPSegment *tcpseg, IPvXAddress src, IPvXAddress dest)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Utility: send IP packet to destination node.  <a href="#a5ab8e1fecb4a30b73b211cbae1c66f99"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="classSimpleTCPConnection.html">SimpleTCPConnection</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classSimpleTCPConnection.html#a49f65ebc48520e42c7fe947d62757694">cloneListeningConnection</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Utility: clone a listening connection.  <a href="#a49f65ebc48520e42c7fe947d62757694"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>

<p>Definition at line <a class="el" href="SimpleTCP_8h_source.html#l00073">73</a> of file <a class="el" href="SimpleTCP_8h_source.html">SimpleTCP.h</a>.</p>
<hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="afb617c21fcd5a0d0f2473b18c9402c6e"></a><!-- doxytag: member="SimpleTCPConnection::SimpleTCPConnection" ref="afb617c21fcd5a0d0f2473b18c9402c6e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SimpleTCPConnection::SimpleTCPConnection </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="SimpleTCP_8h_source.html#l00076">76</a> of file <a class="el" href="SimpleTCP_8h_source.html">SimpleTCP.h</a>.</p>

<p>Referenced by <a class="el" href="SimpleTCP_8cc_source.html#l00248">cloneListeningConnection()</a>.</p>

<p><div class="fragment"><pre class="fragment">:TCPConnection(){};
</pre></div></p>

</div>
</div>
<a class="anchor" id="a63d9cfb0c22610e1986ec0474e48aa48"></a><!-- doxytag: member="SimpleTCPConnection::SimpleTCPConnection" ref="a63d9cfb0c22610e1986ec0474e48aa48" args="(TCP *mod, int appGateIndex, int connId)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SimpleTCPConnection::SimpleTCPConnection </td>
          <td>(</td>
          <td class="paramtype">TCP *&nbsp;</td>
          <td class="paramname"> <em>mod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>appGateIndex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>connId</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="SimpleTCP_8h_source.html#l00077">77</a> of file <a class="el" href="SimpleTCP_8h_source.html">SimpleTCP.h</a>.</p>

<p><div class="fragment"><pre class="fragment">:TCPConnection(mod, appGateIndex, connId){};
</pre></div></p>

</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a49f65ebc48520e42c7fe947d62757694"></a><!-- doxytag: member="SimpleTCPConnection::cloneListeningConnection" ref="a49f65ebc48520e42c7fe947d62757694" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classSimpleTCPConnection.html">SimpleTCPConnection</a> * SimpleTCPConnection::cloneListeningConnection </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Utility: clone a listening connection. </p>
<p>Used for forking. </p>

<p>Definition at line <a class="el" href="SimpleTCP_8cc_source.html#l00248">248</a> of file <a class="el" href="SimpleTCP_8cc_source.html">SimpleTCP.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
    <a class="code" href="classSimpleTCPConnection.html">SimpleTCPConnection</a> *conn = <span class="keyword">new</span> <a class="code" href="classSimpleTCPConnection.html#afb617c21fcd5a0d0f2473b18c9402c6e">SimpleTCPConnection</a>(tcpMain,appGateIndex,connId);

    <span class="comment">// following code to be kept consistent with initConnection()</span>
    <span class="keyword">const</span> <span class="keywordtype">char</span> *sendQueueClass = sendQueue-&gt;getClassName();
    conn-&gt;sendQueue = check_and_cast&lt;TCPSendQueue *&gt;(createOne(sendQueueClass));
    conn-&gt;sendQueue-&gt;setConnection(conn);

    <span class="keyword">const</span> <span class="keywordtype">char</span> *receiveQueueClass = receiveQueue-&gt;getClassName();
    conn-&gt;receiveQueue = check_and_cast&lt;TCPReceiveQueue *&gt;(createOne(receiveQueueClass));
    conn-&gt;receiveQueue-&gt;setConnection(conn);

    <span class="comment">// create SACK retransmit queue</span>
    rexmitQueue = <span class="keyword">new</span> TCPSACKRexmitQueue();
    rexmitQueue-&gt;setConnection(<span class="keyword">this</span>);

    <span class="keyword">const</span> <span class="keywordtype">char</span> *tcpAlgorithmClass = tcpAlgorithm-&gt;getClassName();
    conn-&gt;tcpAlgorithm = check_and_cast&lt;TCPAlgorithm *&gt;(createOne(tcpAlgorithmClass));
    conn-&gt;tcpAlgorithm-&gt;setConnection(conn);

    conn-&gt;state = conn-&gt;tcpAlgorithm-&gt;getStateVariables();
    configureStateVariables();
    conn-&gt;tcpAlgorithm-&gt;initialize();

    <span class="comment">// put it into LISTEN, with our localAddr/localPort</span>
    conn-&gt;state-&gt;active = <span class="keyword">false</span>;
    conn-&gt;state-&gt;fork = <span class="keyword">true</span>;
    conn-&gt;localAddr = localAddr;
    conn-&gt;localPort = localPort;
    FSM_Goto(conn-&gt;fsm, TCP_S_LISTEN);

    <span class="keywordflow">return</span> conn;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2a90f7b7c30ac18b6bb8976d36f56623"></a><!-- doxytag: member="SimpleTCPConnection::sendRst" ref="a2a90f7b7c30ac18b6bb8976d36f56623" args="(uint32 seq, IPvXAddress src, IPvXAddress dest, int srcPort, int destPort)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SimpleTCPConnection::sendRst </td>
          <td>(</td>
          <td class="paramtype">uint32&nbsp;</td>
          <td class="paramname"> <em>seq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IPvXAddress&nbsp;</td>
          <td class="paramname"> <em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IPvXAddress&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>srcPort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>destPort</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Utility: sends RST; does not use connection state. </p>

<p>Definition at line <a class="el" href="SimpleTCP_8cc_source.html#l00284">284</a> of file <a class="el" href="SimpleTCP_8cc_source.html">SimpleTCP.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
    TCPSegment *tcpseg = createTCPSegment(<span class="stringliteral">&quot;RST&quot;</span>);

    tcpseg-&gt;setSrcPort(srcPort);
    tcpseg-&gt;setDestPort(destPort);

    tcpseg-&gt;setRstBit(<span class="keyword">true</span>);
    tcpseg-&gt;setSequenceNo(seq);

    <span class="comment">// send it</span>
    <a class="code" href="classSimpleTCPConnection.html#aef7a2dec538af071e0c7706cd9ec9686" title="Utility: adds control info to segment and sends it to the destination node.">SimpleTCPConnection::sendToIP</a>(tcpseg, src, dest);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a34e0bd4cc145e5b2247a709fa41366c2"></a><!-- doxytag: member="SimpleTCPConnection::sendRstAck" ref="a34e0bd4cc145e5b2247a709fa41366c2" args="(uint32 seq, uint32 ack, IPvXAddress src, IPvXAddress dest, int srcPort, int destPort)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SimpleTCPConnection::sendRstAck </td>
          <td>(</td>
          <td class="paramtype">uint32&nbsp;</td>
          <td class="paramname"> <em>seq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32&nbsp;</td>
          <td class="paramname"> <em>ack</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IPvXAddress&nbsp;</td>
          <td class="paramname"> <em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IPvXAddress&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>srcPort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>destPort</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Utility: sends RST+ACK; does not use connection state. </p>

<p>Definition at line <a class="el" href="SimpleTCP_8cc_source.html#l00298">298</a> of file <a class="el" href="SimpleTCP_8cc_source.html">SimpleTCP.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
    TCPSegment *tcpseg = createTCPSegment(<span class="stringliteral">&quot;RST+ACK&quot;</span>);

    tcpseg-&gt;setSrcPort(srcPort);
    tcpseg-&gt;setDestPort(destPort);

    tcpseg-&gt;setRstBit(<span class="keyword">true</span>);
    tcpseg-&gt;setAckBit(<span class="keyword">true</span>);
    tcpseg-&gt;setSequenceNo(seq);
    tcpseg-&gt;setAckNo(ack);

    <span class="comment">// send it</span>
    <a class="code" href="classSimpleTCPConnection.html#aef7a2dec538af071e0c7706cd9ec9686" title="Utility: adds control info to segment and sends it to the destination node.">SimpleTCPConnection::sendToIP</a>(tcpseg, src, dest);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5ab8e1fecb4a30b73b211cbae1c66f99"></a><!-- doxytag: member="SimpleTCPConnection::sendToIP" ref="a5ab8e1fecb4a30b73b211cbae1c66f99" args="(TCPSegment *tcpseg, IPvXAddress src, IPvXAddress dest)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SimpleTCPConnection::sendToIP </td>
          <td>(</td>
          <td class="paramtype">TCPSegment *&nbsp;</td>
          <td class="paramname"> <em>tcpseg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IPvXAddress&nbsp;</td>
          <td class="paramname"> <em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IPvXAddress&nbsp;</td>
          <td class="paramname"> <em>dest</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Utility: send IP packet to destination node. </p>

<p>Definition at line <a class="el" href="SimpleTCP_8cc_source.html#l00454">454</a> of file <a class="el" href="SimpleTCP_8cc_source.html">SimpleTCP.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{

    <span class="comment">/* main modifications for SimpleTCP start here */</span>
    <a class="code" href="structStatisticsAndDelay.html">StatisticsAndDelay</a>&amp; <a class="code" href="classSimpleTCPConnection.html#a03830f7573a62f195399f9d079be26a4">sad</a> = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSimpleTCP.html">SimpleTCP</a>*<span class="keyword">&gt;</span>(tcpMain)-&gt;sad;

    <a class="code" href="classSimpleInfo.html">SimpleInfo</a>* info = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSimpleInfo.html">SimpleInfo</a>*<span class="keyword">&gt;</span>(sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a985bf687f11d68d4a6699e7fa2367e9a" title="Searches the peerSet for the specified node.">getPeerInfo</a>(dest));
    sad.<a class="code" href="structStatisticsAndDelay.html#aeb20fdd2c64084ebe3038bfa988a9c15" title="number of sent packets">numSent</a>++;

    <span class="keywordflow">if</span> (info == NULL) {
        EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
           &lt;&lt; <span class="stringliteral">&quot;    No route to host &quot;</span> &lt;&lt; dest
           &lt;&lt; endl;

        <span class="keyword">delete</span> tcpseg;
        sad.<a class="code" href="structStatisticsAndDelay.html#aca04ef22c6c8bd65cd98a7af58d577dc" title="number of lost packets due to unavailable destination">numDestUnavailableLost</a>++;
        <span class="keywordflow">return</span>;
    }

    <a class="code" href="classSimpleNodeEntry.html" title="representation of a single node in the GlobalNodeList">SimpleNodeEntry</a>* destEntry = info-&gt;<a class="code" href="classSimpleInfo.html#a7d92b7fa6ca2efd7f4bbe1ab366215d5">getEntry</a>();

    <span class="comment">// calculate delay</span>
    simtime_t totalDelay = 0;
    <span class="keywordflow">if</span> (src != dest) {
        <a class="code" href="classSimpleNodeEntry.html#a094ba8b4401210dc532f789b354a13a2" title="type for return value of calcDelay()">SimpleNodeEntry::SimpleDelay</a> temp;
        <span class="keywordflow">if</span> (sad.<a class="code" href="structStatisticsAndDelay.html#a94c50ce1f8cadf64798d65257cd17725">faultyDelay</a>) {
            <a class="code" href="classSimpleInfo.html">SimpleInfo</a>* thisInfo = <span class="keyword">static_cast&lt;</span><a class="code" href="classSimpleInfo.html">SimpleInfo</a>*<span class="keyword">&gt;</span>(sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a985bf687f11d68d4a6699e7fa2367e9a" title="Searches the peerSet for the specified node.">getPeerInfo</a>(src));
            temp = sad.<a class="code" href="structStatisticsAndDelay.html#a9ff3d8314da300706b11edfda9c43ef5" title="nodeEntry of the overlay node this module belongs to">nodeEntry</a>-&gt;<a class="code" href="classSimpleNodeEntry.html#a90f3eef9b439cc9ba4282be89c8745ae" title="Calculates delay between two nodes.">calcDelay</a>(tcpseg, *destEntry,
                                        !(thisInfo-&gt;<a class="code" href="classPeerInfo.html#a5081c729d9f242ad2c0e8fba6f74b809" title="returns the NPS layer of the peer">getNpsLayer</a>() == 0 ||
                                          info-&gt;<a class="code" href="classPeerInfo.html#a5081c729d9f242ad2c0e8fba6f74b809" title="returns the NPS layer of the peer">getNpsLayer</a>() == 0)); <span class="comment">//TODO</span>
        } <span class="keywordflow">else</span> {
            temp = sad.<a class="code" href="structStatisticsAndDelay.html#a9ff3d8314da300706b11edfda9c43ef5" title="nodeEntry of the overlay node this module belongs to">nodeEntry</a>-&gt;<a class="code" href="classSimpleNodeEntry.html#a90f3eef9b439cc9ba4282be89c8745ae" title="Calculates delay between two nodes.">calcDelay</a>(tcpseg, *destEntry);
        }
        <span class="keywordflow">if</span> (sad.<a class="code" href="structStatisticsAndDelay.html#a888474d52c0422097930c2abe1c61d74" title="delay should be calculated from euklidean distance between two peers">useCoordinateBasedDelay</a> == <span class="keyword">false</span>) {
            totalDelay = sad.<a class="code" href="structStatisticsAndDelay.html#a5e1bfce6c505beb5dc3f32e3a264878f" title="constant delay between two peers">constantDelay</a>;
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (temp.second == <span class="keyword">false</span>) {
            EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
               &lt;&lt; <span class="stringliteral">&quot;    Send queue full: packet &quot;</span> &lt;&lt; tcpseg &lt;&lt; <span class="stringliteral">&quot; dropped&quot;</span>
               &lt;&lt; endl;
            <span class="keyword">delete</span> tcpseg;
            sad.<a class="code" href="structStatisticsAndDelay.html#ac0fb0c280a914930b352e7d3c5f45e2c" title="number of lost packets due to queue full">numQueueLost</a>++;
            <span class="keywordflow">return</span>;
        } <span class="keywordflow">else</span> {
            totalDelay = temp.first;
        }
    }

    <a class="code" href="classSimpleInfo.html">SimpleInfo</a>* thisInfo = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSimpleInfo.html">SimpleInfo</a>*<span class="keyword">&gt;</span>(sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a985bf687f11d68d4a6699e7fa2367e9a" title="Searches the peerSet for the specified node.">getPeerInfo</a>(src));

    <span class="keywordflow">if</span> (!sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#ae316b0571ddcfafa6cbaaf1c82cc793a">areNodeTypesConnected</a>(thisInfo-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>(), info-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>())) {
        EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
                   &lt;&lt; <span class="stringliteral">&quot;    Partition &quot;</span> &lt;&lt; thisInfo-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>() &lt;&lt; <span class="stringliteral">&quot;-&gt;&quot;</span> &lt;&lt; info-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>()
                   &lt;&lt; <span class="stringliteral">&quot; is not connected&quot;</span>
                   &lt;&lt; endl;
        <span class="keyword">delete</span> tcpseg;
        sad.<a class="code" href="structStatisticsAndDelay.html#a836c38197079b0f21a52eb2cd5544576" title="number of lost packets due to network partitions">numPartitionLost</a>++;
        <span class="keywordflow">return</span>;
    }

    <span class="keywordflow">if</span> (sad.<a class="code" href="structStatisticsAndDelay.html#a6411eade894d17778e15653bed25f2ff" title="amount of jitter in % of total delay">jitter</a>) {
        <span class="comment">// jitter</span>
        <span class="comment">//totalDelay += truncnormal(0, SIMTIME_DBL(totalDelay) * jitter);</span>

        <span class="comment">//workaround (bug in truncnormal(): sometimes returns inf)</span>
        <span class="keywordtype">double</span> temp = truncnormal(0, SIMTIME_DBL(totalDelay) * sad.<a class="code" href="structStatisticsAndDelay.html#a6411eade894d17778e15653bed25f2ff" title="amount of jitter in % of total delay">jitter</a>);
        <span class="keywordflow">while</span> (temp == INFINITY || temp != temp) { <span class="comment">// reroll if temp is INF or NaN</span>
            std::cerr &lt;&lt; <span class="stringliteral">&quot;\n******* SimpleTCPConnection: truncnormal() -&gt; inf !!\n&quot;</span>
                      &lt;&lt; std::endl;
            temp = truncnormal(0, SIMTIME_DBL(totalDelay) * sad.<a class="code" href="structStatisticsAndDelay.html#a6411eade894d17778e15653bed25f2ff" title="amount of jitter in % of total delay">jitter</a>);
        }

        totalDelay += temp;
    }



    EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
       &lt;&lt; <span class="stringliteral">&quot;    Packet &quot;</span> &lt;&lt; tcpseg &lt;&lt; <span class="stringliteral">&quot; sent with delay = &quot;</span> &lt;&lt; totalDelay
       &lt;&lt; endl;

    <span class="comment">//RECORD_STATS(globalStatistics-&gt;addStdDev(&quot;SimpleTCP: delay&quot;, totalDelay));</span>


    <span class="comment">/* main modifications for SimpleTCP end here */</span>

    tcpEV &lt;&lt; <span class="stringliteral">&quot;Sending: &quot;</span>;
    printSegmentBrief(tcpseg);

    <span class="keywordflow">if</span> (!dest.isIPv6())
    {
        <span class="comment">// send over IPv4</span>
        IPControlInfo *controlInfo = <span class="keyword">new</span> IPControlInfo();
        controlInfo-&gt;setProtocol(IP_PROT_TCP);
        controlInfo-&gt;setSrcAddr(src.get4());
        controlInfo-&gt;setDestAddr(dest.get4());
        tcpseg-&gt;setControlInfo(controlInfo);

        check_and_cast&lt;TCP *&gt;(simulation.getContextModule())-&gt;sendDirect(tcpseg, totalDelay, 0, destEntry-&gt;<a class="code" href="classSimpleNodeEntry.html#a3f9699297423052c76601da9e29d0db0" title="Getter for SimpleUDP ingate.">getTcpIPv4Gate</a>());
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// send over IPv6</span>
        IPv6ControlInfo *controlInfo = <span class="keyword">new</span> IPv6ControlInfo();
        controlInfo-&gt;setProtocol(IP_PROT_TCP);
        controlInfo-&gt;setSrcAddr(src.get6());
        controlInfo-&gt;setDestAddr(dest.get6());
        tcpseg-&gt;setControlInfo(controlInfo);

        check_and_cast&lt;TCP *&gt;(simulation.getContextModule())-&gt;sendDirect(tcpseg, totalDelay, 0, destEntry-&gt;<a class="code" href="classSimpleNodeEntry.html#a765ef14c71b289379465748164c5cf19" title="Getter for SimpleUDP IPv6 ingate.">getTcpIPv6Gate</a>());
    }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="aef7a2dec538af071e0c7706cd9ec9686"></a><!-- doxytag: member="SimpleTCPConnection::sendToIP" ref="aef7a2dec538af071e0c7706cd9ec9686" args="(TCPSegment *tcpseg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SimpleTCPConnection::sendToIP </td>
          <td>(</td>
          <td class="paramtype">TCPSegment *&nbsp;</td>
          <td class="paramname"> <em>tcpseg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Utility: adds control info to segment and sends it to the destination node. </p>

<p>Definition at line <a class="el" href="SimpleTCP_8cc_source.html#l00314">314</a> of file <a class="el" href="SimpleTCP_8cc_source.html">SimpleTCP.cc</a>.</p>

<p>Referenced by <a class="el" href="SimpleTCP_8cc_source.html#l00284">sendRst()</a>, and <a class="el" href="SimpleTCP_8cc_source.html#l00298">sendRstAck()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
    <a class="code" href="structStatisticsAndDelay.html">StatisticsAndDelay</a>&amp; <a class="code" href="classSimpleTCPConnection.html#a03830f7573a62f195399f9d079be26a4">sad</a> = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSimpleTCP.html">SimpleTCP</a>*<span class="keyword">&gt;</span>(tcpMain)-&gt;sad;
    <span class="comment">// record seq (only if we do send data) and ackno</span>
    <span class="keywordflow">if</span> (sndNxtVector &amp;&amp; tcpseg-&gt;getPayloadLength()!=0)
        sndNxtVector-&gt;record(tcpseg-&gt;getSequenceNo());
    <span class="keywordflow">if</span> (sndAckVector)
        sndAckVector-&gt;record(tcpseg-&gt;getAckNo());

    <span class="comment">// final touches on the segment before sending</span>
    tcpseg-&gt;setSrcPort(localPort);
    tcpseg-&gt;setDestPort(remotePort);
    ASSERT(tcpseg-&gt;getHeaderLength() &gt;= TCP_HEADER_OCTETS);     <span class="comment">// TCP_HEADER_OCTETS = 20 (without options)</span>
    ASSERT(tcpseg-&gt;getHeaderLength() &lt;= TCP_MAX_HEADER_OCTETS); <span class="comment">// TCP_MAX_HEADER_OCTETS = 60</span>

    <span class="comment">// add header byte length for the skipped IP header</span>
    <span class="keywordtype">int</span> ipHeaderBytes = 0;
    <span class="keywordflow">if</span> (remoteAddr.isIPv6()) {
        ipHeaderBytes = <a class="code" href="SimpleUDP_8h.html#a8a09101d202f638c784b6d4eec10b0fc">IPv6_HEADER_BYTES</a>;
    } <span class="keywordflow">else</span> {
        ipHeaderBytes = IP_HEADER_BYTES;
    }
    tcpseg-&gt;setByteLength(tcpseg-&gt;getHeaderLength() +
                          tcpseg-&gt;getPayloadLength() + ipHeaderBytes);

    tcpEV &lt;&lt; <span class="stringliteral">&quot;Sending: &quot;</span>;
    printSegmentBrief(tcpseg);

    <span class="comment">// TBD reuse next function for sending</span>


    <span class="comment">/* main modifications for SimpleTCP start here */</span>

    <span class="keyword">const</span> IPvXAddress&amp; src = IPAddressResolver().addressOf(tcpMain-&gt;getParentModule());
    <span class="comment">//const IPvXAddress&amp; src = localAddr;</span>
    <span class="keyword">const</span> IPvXAddress&amp; dest = remoteAddr;

    <a class="code" href="classSimpleInfo.html">SimpleInfo</a>* info = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSimpleInfo.html">SimpleInfo</a>*<span class="keyword">&gt;</span>(sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a985bf687f11d68d4a6699e7fa2367e9a" title="Searches the peerSet for the specified node.">getPeerInfo</a>(dest));
    sad.<a class="code" href="structStatisticsAndDelay.html#aeb20fdd2c64084ebe3038bfa988a9c15" title="number of sent packets">numSent</a>++;

    <span class="keywordflow">if</span> (info == NULL) {
        EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
           &lt;&lt; <span class="stringliteral">&quot;    No route to host &quot;</span> &lt;&lt; dest
           &lt;&lt; endl;

        <span class="keyword">delete</span> tcpseg;
        sad.<a class="code" href="structStatisticsAndDelay.html#aca04ef22c6c8bd65cd98a7af58d577dc" title="number of lost packets due to unavailable destination">numDestUnavailableLost</a>++;
        <span class="keywordflow">return</span>;
    }

    <a class="code" href="classSimpleNodeEntry.html" title="representation of a single node in the GlobalNodeList">SimpleNodeEntry</a>* destEntry = info-&gt;<a class="code" href="classSimpleInfo.html#a7d92b7fa6ca2efd7f4bbe1ab366215d5">getEntry</a>();

    <span class="comment">// calculate delay</span>
    simtime_t totalDelay = 0;
    <span class="keywordflow">if</span> (src != dest) {
        <a class="code" href="classSimpleNodeEntry.html#a094ba8b4401210dc532f789b354a13a2" title="type for return value of calcDelay()">SimpleNodeEntry::SimpleDelay</a> temp;
        <span class="keywordflow">if</span> (sad.<a class="code" href="structStatisticsAndDelay.html#a94c50ce1f8cadf64798d65257cd17725">faultyDelay</a>) {
            <a class="code" href="classSimpleInfo.html">SimpleInfo</a>* thisInfo = <span class="keyword">static_cast&lt;</span><a class="code" href="classSimpleInfo.html">SimpleInfo</a>*<span class="keyword">&gt;</span>(sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a985bf687f11d68d4a6699e7fa2367e9a" title="Searches the peerSet for the specified node.">getPeerInfo</a>(src));
            temp = sad.<a class="code" href="structStatisticsAndDelay.html#a9ff3d8314da300706b11edfda9c43ef5" title="nodeEntry of the overlay node this module belongs to">nodeEntry</a>-&gt;<a class="code" href="classSimpleNodeEntry.html#a90f3eef9b439cc9ba4282be89c8745ae" title="Calculates delay between two nodes.">calcDelay</a>(tcpseg, *destEntry,
                                        !(thisInfo-&gt;<a class="code" href="classPeerInfo.html#a5081c729d9f242ad2c0e8fba6f74b809" title="returns the NPS layer of the peer">getNpsLayer</a>() == 0 ||
                                          info-&gt;<a class="code" href="classPeerInfo.html#a5081c729d9f242ad2c0e8fba6f74b809" title="returns the NPS layer of the peer">getNpsLayer</a>() == 0)); <span class="comment">//TODO</span>
        } <span class="keywordflow">else</span> {
            temp = sad.<a class="code" href="structStatisticsAndDelay.html#a9ff3d8314da300706b11edfda9c43ef5" title="nodeEntry of the overlay node this module belongs to">nodeEntry</a>-&gt;<a class="code" href="classSimpleNodeEntry.html#a90f3eef9b439cc9ba4282be89c8745ae" title="Calculates delay between two nodes.">calcDelay</a>(tcpseg, *destEntry);
        }
        <span class="keywordflow">if</span> (sad.<a class="code" href="structStatisticsAndDelay.html#a888474d52c0422097930c2abe1c61d74" title="delay should be calculated from euklidean distance between two peers">useCoordinateBasedDelay</a> == <span class="keyword">false</span>) {
            totalDelay = sad.<a class="code" href="structStatisticsAndDelay.html#a5e1bfce6c505beb5dc3f32e3a264878f" title="constant delay between two peers">constantDelay</a>;
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (temp.second == <span class="keyword">false</span>) {
            EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
               &lt;&lt; <span class="stringliteral">&quot;    Send queue full: packet &quot;</span> &lt;&lt; tcpseg &lt;&lt; <span class="stringliteral">&quot; dropped&quot;</span>
               &lt;&lt; endl;
            <span class="keyword">delete</span> tcpseg;
            sad.<a class="code" href="structStatisticsAndDelay.html#ac0fb0c280a914930b352e7d3c5f45e2c" title="number of lost packets due to queue full">numQueueLost</a>++;
            <span class="keywordflow">return</span>;
        } <span class="keywordflow">else</span> {
            totalDelay = temp.first;
        }
    }

    <a class="code" href="classSimpleInfo.html">SimpleInfo</a>* thisInfo = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classSimpleInfo.html">SimpleInfo</a>*<span class="keyword">&gt;</span>(sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a985bf687f11d68d4a6699e7fa2367e9a" title="Searches the peerSet for the specified node.">getPeerInfo</a>(src));

    <span class="keywordflow">if</span> (!sad.<a class="code" href="structStatisticsAndDelay.html#a5512c6e7fd7a47e681f2a8dc3e50cc3a" title="violate the triangle inequality?">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#ae316b0571ddcfafa6cbaaf1c82cc793a">areNodeTypesConnected</a>(thisInfo-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>(), info-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>())) {
        EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
                   &lt;&lt; <span class="stringliteral">&quot;    Partition &quot;</span> &lt;&lt; thisInfo-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>() &lt;&lt; <span class="stringliteral">&quot;-&gt;&quot;</span> &lt;&lt; info-&gt;<a class="code" href="classPeerInfo.html#a7b01dcdd9a7828c03feef39d5135ab1d" title="returns the type of the node">getTypeID</a>()
                   &lt;&lt; <span class="stringliteral">&quot; is not connected&quot;</span>
                   &lt;&lt; endl;
        <span class="keyword">delete</span> tcpseg;
        sad.<a class="code" href="structStatisticsAndDelay.html#a836c38197079b0f21a52eb2cd5544576" title="number of lost packets due to network partitions">numPartitionLost</a>++;
        <span class="keywordflow">return</span>;
    }

    <span class="keywordflow">if</span> (sad.<a class="code" href="structStatisticsAndDelay.html#a6411eade894d17778e15653bed25f2ff" title="amount of jitter in % of total delay">jitter</a>) {
        <span class="comment">// jitter</span>
        <span class="comment">//totalDelay += truncnormal(0, SIMTIME_DBL(totalDelay) * jitter);</span>

        <span class="comment">//workaround (bug in truncnormal(): sometimes returns inf)</span>
        <span class="keywordtype">double</span> temp = truncnormal(0, SIMTIME_DBL(totalDelay) * sad.<a class="code" href="structStatisticsAndDelay.html#a6411eade894d17778e15653bed25f2ff" title="amount of jitter in % of total delay">jitter</a>);
        <span class="keywordflow">while</span> (temp == INFINITY || temp != temp) { <span class="comment">// reroll if temp is INF or NaN</span>
            std::cerr &lt;&lt; <span class="stringliteral">&quot;\n******* SimpleTCPConnection: truncnormal() -&gt; inf !!\n&quot;</span>
                      &lt;&lt; std::endl;
            temp = truncnormal(0, SIMTIME_DBL(totalDelay) * sad.<a class="code" href="structStatisticsAndDelay.html#a6411eade894d17778e15653bed25f2ff" title="amount of jitter in % of total delay">jitter</a>);
        }

        totalDelay += temp;
    }



    EV &lt;&lt; <span class="stringliteral">&quot;[SimpleTCPConnection::sendToIP() @ &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span>
       &lt;&lt; <span class="stringliteral">&quot;    Packet &quot;</span> &lt;&lt; tcpseg &lt;&lt; <span class="stringliteral">&quot; sent with delay = &quot;</span> &lt;&lt; totalDelay
       &lt;&lt; endl;

    <span class="comment">//RECORD_STATS(globalStatistics-&gt;addStdDev(&quot;SimpleTCP: delay&quot;, totalDelay));</span>


    <span class="comment">/* main modifications for SimpleTCP end here */</span>

    <span class="keywordflow">if</span> (!remoteAddr.isIPv6())
    {
        <span class="comment">// send over IPv4</span>
        IPControlInfo *controlInfo = <span class="keyword">new</span> IPControlInfo();
        controlInfo-&gt;setProtocol(IP_PROT_TCP);
        controlInfo-&gt;setSrcAddr(src.get4());
        controlInfo-&gt;setDestAddr(dest.get4());
        tcpseg-&gt;setControlInfo(controlInfo);

        tcpMain-&gt;sendDirect(tcpseg, totalDelay, 0, destEntry-&gt;<a class="code" href="classSimpleNodeEntry.html#a3f9699297423052c76601da9e29d0db0" title="Getter for SimpleUDP ingate.">getTcpIPv4Gate</a>());
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// send over IPv6</span>
        IPv6ControlInfo *controlInfo = <span class="keyword">new</span> IPv6ControlInfo();
        controlInfo-&gt;setProtocol(IP_PROT_TCP);
        controlInfo-&gt;setSrcAddr(src.get6());
        controlInfo-&gt;setDestAddr(dest.get6());
        tcpseg-&gt;setControlInfo(controlInfo);

        tcpMain-&gt;sendDirect(tcpseg, totalDelay, 0, destEntry-&gt;<a class="code" href="classSimpleNodeEntry.html#a765ef14c71b289379465748164c5cf19" title="Getter for SimpleUDP IPv6 ingate.">getTcpIPv6Gate</a>());
    }
}
</pre></div></p>

</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="a03830f7573a62f195399f9d079be26a4"></a><!-- doxytag: member="SimpleTCPConnection::sad" ref="a03830f7573a62f195399f9d079be26a4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structStatisticsAndDelay.html">StatisticsAndDelay</a> <a class="el" href="classSimpleTCPConnection.html#a03830f7573a62f195399f9d079be26a4">SimpleTCPConnection::sad</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="SimpleTCP_8h_source.html#l00082">82</a> of file <a class="el" href="SimpleTCP_8h_source.html">SimpleTCP.h</a>.</p>

<p>Referenced by <a class="el" href="SimpleTCP_8cc_source.html#l00314">sendToIP()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="SimpleTCP_8h_source.html">SimpleTCP.h</a></li>
<li><a class="el" href="SimpleTCP_8cc_source.html">SimpleTCP.cc</a></li>
</ul>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 3 2010 14:40:55 for OverSim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
