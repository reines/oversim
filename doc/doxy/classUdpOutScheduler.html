<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: UdpOutScheduler Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="#pro-attribs">Protected Attributes</a>  </div>
  <div class="headertitle">
<h1>UdpOutScheduler Class Reference</h1>  </div>
</div>
<div class="contents">
<!-- doxytag: class="UdpOutScheduler" --><!-- doxytag: inherits="RealtimeScheduler" -->
<p><code>#include &lt;<a class="el" href="udpoutscheduler_8h_source.html">udpoutscheduler.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for UdpOutScheduler:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classUdpOutScheduler.png" usemap="#UdpOutScheduler_map" alt=""/>
  <map id="UdpOutScheduler_map" name="UdpOutScheduler_map">
<area href="classRealtimeScheduler.html" alt="RealtimeScheduler" shape="rect" coords="0,0,117,24"/>
</map>
</div>

<p><a href="classUdpOutScheduler-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classUdpOutScheduler.html#a18a5b61e3cf0193bd0af3565bf73093e">~UdpOutScheduler</a> ()</td></tr>
<tr><td colspan="2"><h2><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classUdpOutScheduler.html#a58be0295c7d02e0becbc37d9da27572c">initializeNetwork</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize the network.  <a href="#a58be0295c7d02e0becbc37d9da27572c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classUdpOutScheduler.html#ac9a5e1e72556809f04a44991e6f0b437">additionalFD</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function is called from main loop if data is accessible from "additional_fd".  <a href="#ac9a5e1e72556809f04a44991e6f0b437"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="pro-attribs"></a>
Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classUdpOutScheduler.html#a4e458e0a5b32ab4d604e453a1ad6d399">dev</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>

<p>Definition at line <a class="el" href="udpoutscheduler_8h_source.html#l00032">32</a> of file <a class="el" href="udpoutscheduler_8h_source.html">udpoutscheduler.h</a>.</p>
<hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a18a5b61e3cf0193bd0af3565bf73093e"></a><!-- doxytag: member="UdpOutScheduler::~UdpOutScheduler" ref="a18a5b61e3cf0193bd0af3565bf73093e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">UdpOutScheduler::~UdpOutScheduler </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="udpoutscheduler_8cc_source.html#l00033">33</a> of file <a class="el" href="udpoutscheduler_8cc_source.html">udpoutscheduler.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a> &gt;= 0) {
<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>        closesocket(<a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        close(<a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
}
</pre></div></p>

</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="ac9a5e1e72556809f04a44991e6f0b437"></a><!-- doxytag: member="UdpOutScheduler::additionalFD" ref="ac9a5e1e72556809f04a44991e6f0b437" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void UdpOutScheduler::additionalFD </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This function is called from main loop if data is accessible from "additional_fd". </p>
<p>This FD can be set in initializeNetwork by concrete implementations. </p>

<p>Reimplemented from <a class="el" href="classRealtimeScheduler.html#ad941843b104a83ee36c4700bb6de9da7">RealtimeScheduler</a>.</p>

<p>Definition at line <a class="el" href="udpoutscheduler_8cc_source.html#l00146">146</a> of file <a class="el" href="udpoutscheduler_8cc_source.html">udpoutscheduler.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">                                   {
    sockaddr* from = (sockaddr*) <span class="keyword">new</span> sockaddr_in;
    socklen_t addrlen = <span class="keyword">sizeof</span>(sockaddr_in);

    SOCKET new_sock = accept( <a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a>, from, &amp;addrlen );

    <span class="keywordflow">if</span> (new_sock == INVALID_SOCKET) {
        opp_warning(<span class="stringliteral">&quot;Error connecting to remote app&quot;</span>);
        <span class="keywordflow">return</span>;
    }

    <span class="keywordflow">if</span> (<a class="code" href="classRealtimeScheduler.html#ae9fa7c77861365573b4d5b8deaa942c6">appConnectionLimit</a>) {
        <span class="keywordtype">int</span> count = 0;

        <span class="keywordflow">for</span> (SOCKET fd = 0; fd &lt;= <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a>; fd++) {
            <span class="keywordflow">if</span> (fd == <a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>) <span class="keywordflow">continue</span>;
            <span class="keywordflow">if</span> (fd == <a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a>) <span class="keywordflow">continue</span>;
            <span class="keywordflow">if</span> (FD_ISSET(fd, &amp;<a class="code" href="classRealtimeScheduler.html#a7468f001f080f62bf567b6a56a3b18d4">all_fds</a>)) count++;
        }

        <span class="keywordflow">if</span> (count &gt;= <a class="code" href="classRealtimeScheduler.html#ae9fa7c77861365573b4d5b8deaa942c6">appConnectionLimit</a>) {
            <span class="comment">// We already have too many connections to external applications</span>
            <span class="comment">// &quot;reject&quot; connection</span>
<span class="preprocessor">#ifdef _WIN32</span>
<span class="preprocessor"></span>            closesocket(new_sock);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            close(new_sock);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>            ev &lt;&lt; <span class="stringliteral">&quot;[UdpOutScheduler::additionalFD()]\n&quot;</span>
               &lt;&lt; <span class="stringliteral">&quot;    Rejecting new app connection (FD: &quot;</span> &lt;&lt; new_sock &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>
               &lt;&lt; endl;

            <span class="keywordflow">return</span>;
        }
    }

    FD_SET(new_sock, &amp;<a class="code" href="classRealtimeScheduler.html#a7468f001f080f62bf567b6a56a3b18d4">all_fds</a>);

    <span class="keywordflow">if</span> (new_sock &gt; <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a>) {
        <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a> = new_sock;
    }

    <span class="comment">// Inform app about new connection</span>
    <a class="code" href="classRealtimeScheduler.html#a9cf297ceaba1fbb4a66d847b348dae3c">appPacketBuffer</a>-&gt;push_back(PacketBufferEntry(0, 0, from, addrlen,
                               <a class="code" href="classRealtimeScheduler_1_1PacketBufferEntry.html#a7a03bec74e01f2a01bdf90ed5515c2e6a3fcc49b08b37788c063c293398d6512f">PacketBufferEntry::PACKET_FD_NEW</a>, new_sock));

    <a class="code" href="classRealtimeScheduler.html#a93b772a5520c804c7a208de45e1a1e16" title="send notification msg to module">sendNotificationMsg</a>(<a class="code" href="classRealtimeScheduler.html#ab4eced162d7a38aeccc4c4cd5381f276">appNotificationMsg</a>, <a class="code" href="classRealtimeScheduler.html#af8eaff4ca345f94aaef1fe26c5be508e">appModule</a>);

    ev &lt;&lt; <span class="stringliteral">&quot;[UdpOutScheduler::additionalFD()]\n&quot;</span>
       &lt;&lt; <span class="stringliteral">&quot;    Accepting new app connection (FD: &quot;</span> &lt;&lt; new_sock &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>
       &lt;&lt; endl;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a58be0295c7d02e0becbc37d9da27572c"></a><!-- doxytag: member="UdpOutScheduler::initializeNetwork" ref="a58be0295c7d02e0becbc37d9da27572c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int UdpOutScheduler::initializeNetwork </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize the network. </p>

<p>Implements <a class="el" href="classRealtimeScheduler.html#aeebd34c4cfa2c9b1b1d1224117b7be3b">RealtimeScheduler</a>.</p>

<p>Definition at line <a class="el" href="udpoutscheduler_8cc_source.html#l00044">44</a> of file <a class="el" href="udpoutscheduler_8cc_source.html">udpoutscheduler.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
    <span class="comment">// get app port (0 if external app is not used)</span>
    <span class="keywordtype">int</span> appPort = ev.getConfig()-&gt;getAsInt(CFGID_EXTERNALAPP_APP_PORT, 0);

    <span class="comment">// Initialize TCP socket for App communication if desired</span>
    <span class="keywordflow">if</span> (appPort &gt; 0) {

        <span class="keyword">struct </span>sockaddr_in server;
        SOCKET sock;

        <span class="comment">// Waiting for a TCP connection</span>
        sock = socket(AF_INET, SOCK_STREAM, 0);

        <span class="keywordflow">if</span> (sock == INVALID_SOCKET) {
            opp_error(<span class="stringliteral">&quot;Error creating socket&quot;</span>);
            <span class="keywordflow">return</span> -1;
        }

        <span class="keywordtype">int</span> on = 1;
        setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, (<span class="keywordtype">char</span>*)&amp;on, <span class="keyword">sizeof</span>(on));

        memset(&amp;server, 0, <span class="keyword">sizeof</span> (server));
        server.sin_family = AF_INET;
        server.sin_addr.s_addr = htonl(INADDR_ANY);
        server.sin_port = htons(appPort);

        <span class="keywordflow">if</span> (bind( sock, (<span class="keyword">struct</span> sockaddr*)&amp;server, <span class="keyword">sizeof</span>( server)) &lt; 0) {
            opp_error(<span class="stringliteral">&quot;Error binding to app socket&quot;</span>);
            <span class="keywordflow">return</span> -1;
        }

        <span class="keywordflow">if</span> (listen( sock, 5 ) == -1) {
            opp_error(<span class="stringliteral">&quot;Error listening on app socket&quot;</span>);
            <span class="keywordflow">return</span> -1;
        }
        <span class="comment">// Set additional_fd so we will be called if data</span>
        <span class="comment">// (i.e. connection requests) is available at sock</span>
        <a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a> = sock;
        FD_SET(<a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a>, &amp;<a class="code" href="classRealtimeScheduler.html#a7468f001f080f62bf567b6a56a3b18d4">all_fds</a>);
        <span class="keywordflow">if</span> (<a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a> &gt; <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a>) {
            <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a> = <a class="code" href="classRealtimeScheduler.html#adaa65c6934b915a6129a284f952d18ed">additional_fd</a>;
        }
    }

    <span class="comment">// Open UDP port</span>
    <span class="keywordflow">if</span> (<a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a> != INVALID_SOCKET) {
        <span class="comment">// Port is already open, reuse it...</span>
        FD_SET(<a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>, &amp;<a class="code" href="classRealtimeScheduler.html#a7468f001f080f62bf567b6a56a3b18d4">all_fds</a>);

        <span class="keywordflow">if</span> (<a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>&gt; <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a>) {
            <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a> = <a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>;
        }

        <span class="keywordflow">return</span> 0;
    }

    sockaddr_in addr;
    <a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a> = socket(AF_INET, SOCK_DGRAM, 0);
    memset(&amp;addr, 0, <span class="keyword">sizeof</span>(addr));
    addr.sin_family = AF_INET;

    cModule* overlay = simulation.getModuleByPath(
            <span class="stringliteral">&quot;SingleHostUnderlayNetwork.overlayTerminal[0].overlay&quot;</span>);

    <span class="keywordflow">if</span> (overlay == NULL) {
        <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;UdpOutScheduler::initializeNetwork(): &quot;</span>
                                <span class="stringliteral">&quot;Overlay module not found!&quot;</span>);
    }

    addr.sin_port = htons(overlay-&gt;gate(<span class="stringliteral">&quot;appIn&quot;</span>)-&gt;getNextGate()-&gt;
                          getOwnerModule()-&gt;par(<span class="stringliteral">&quot;localPort&quot;</span>).longValue());

    cModule* underlayConfigurator =
        simulation.getModuleByPath(<span class="stringliteral">&quot;SingleHostUnderlayNetwork.underlayConfigurator&quot;</span>);

    <span class="keywordflow">if</span> (underlayConfigurator == NULL) {
        <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;UdpOutScheduler::initializeNetwork(): &quot;</span>
                                <span class="stringliteral">&quot;UnderlayConfigurator module not found!&quot;</span>);
    }

    <span class="keywordflow">if</span> (strlen(underlayConfigurator-&gt;par(<span class="stringliteral">&quot;nodeIP&quot;</span>).stringValue())) {
        addr.sin_addr.s_addr = htonl(IPAddress(underlayConfigurator-&gt;
                                       par(<span class="stringliteral">&quot;nodeIP&quot;</span>).stringValue()).getInt());
    } <span class="keywordflow">else</span> {
        addr.sin_addr.s_addr = htonl(INADDR_ANY);
    }

    <span class="keywordflow">if</span> (bind( <a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>, (sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr)) &lt; 0) {
        opp_error(<span class="stringliteral">&quot;Error binding to UDP socket&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    FD_SET(<a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>, &amp;<a class="code" href="classRealtimeScheduler.html#a7468f001f080f62bf567b6a56a3b18d4">all_fds</a>);

    <span class="keywordflow">if</span> (<a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>&gt; <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a>) {
        <a class="code" href="classRealtimeScheduler.html#a1b483610d98af8787a4fcb36903c7796">maxfd</a> = <a class="code" href="classRealtimeScheduler.html#aee2766bfefbbe385593bd0e7f194eba5">netw_fd</a>;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div></p>

</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="a4e458e0a5b32ab4d604e453a1ad6d399"></a><!-- doxytag: member="UdpOutScheduler::dev" ref="a4e458e0a5b32ab4d604e453a1ad6d399" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="classUdpOutScheduler.html#a4e458e0a5b32ab4d604e453a1ad6d399">UdpOutScheduler::dev</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="udpoutscheduler_8h_source.html#l00035">35</a> of file <a class="el" href="udpoutscheduler_8h_source.html">udpoutscheduler.h</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="udpoutscheduler_8h_source.html">udpoutscheduler.h</a></li>
<li><a class="el" href="udpoutscheduler_8cc_source.html">udpoutscheduler.cc</a></li>
</ul>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 3 2010 14:40:55 for OverSim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
